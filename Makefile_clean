# =====================================
# ðŸŒ¸ Iris MLOps Pipeline - Makefile Essencial
# =====================================
-include .env
export

# =====================================
# ðŸ› ï¸ ConfiguraÃ§Ã£o
# =====================================
DATABRICKS_BIN := databricks

# =====================================
# ðŸ”§ Setup e AutenticaÃ§Ã£o
# =====================================

# ðŸ› ï¸ Instala Databricks CLI v0.205+
install-databricks:
	@echo "ðŸš€ Instalando Databricks CLI oficial..."
	@curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
	@echo "âœ… Databricks CLI instalada!"
	@databricks version

# ðŸ” Teste de autenticaÃ§Ã£o
test-auth:
	@echo "ðŸ” Testando autenticaÃ§Ã£o..."
	@set -a && . ./.env && set +a && \
	databricks current-user me

# =====================================
# ðŸ“¦ Deploy e ValidaÃ§Ã£o
# =====================================

# âœ… Validar bundle
validate:
	@echo "ðŸ” Validando bundle..."
	@set -a && . ./.env && set +a && \
	$(DATABRICKS_BIN) bundle validate

# ðŸš€ Deploy do bundle
deploy:
	@echo "ðŸš€ Fazendo deploy..."
	@set -a && . ./.env && set +a && \
	$(DATABRICKS_BIN) bundle deploy --target dev

# =====================================
# ðŸŽ¯ Jobs Essenciais
# =====================================

# ðŸ¥‰ Bronze job (IngestÃ£o)
run_bronze:
	@echo "ðŸ¥‰ Executando Bronze job..."
	@set -a && . ./.env && set +a && \
	databricks bundle run bronze_job

# ðŸ¥ˆ Silver job (TransformaÃ§Ã£o)
run_silver:
	@echo "ðŸ¥ˆ Executando Silver job..."
	@set -a && . ./.env && set +a && \
	databricks bundle run silver_job

# ðŸ¥‡ Gold job (AgregaÃ§Ã£o)
run_gold:
	@echo "ðŸ¥‡ Executando Gold job..."
	@set -a && . ./.env && set +a && \
	databricks bundle run gold_job

# ðŸ¤– Training job (ML)
run_training:
	@echo "ðŸ¤– Executando Training job..."
	@set -a && . ./.env && set +a && \
	databricks bundle run training_job

# ðŸ“Š Monitoring job
run_monitoring:
	@echo "ðŸ“Š Executando Monitoring job..."
	@set -a && . ./.env && set +a && \
	databricks bundle run model_monitoring

# ðŸš€ Pipeline completo orquestrado
run_complete_pipeline:
	@echo "ðŸš€ Executando pipeline completo..."
	@set -a && . ./.env && set +a && \
	databricks bundle run complete_pipeline

# =====================================
# ðŸ”„ Auto-Triggered Pipelines
# =====================================

# Bronze com auto-triggers (recomendado)
run_bronze_with_triggers:
	@echo "ðŸŒŸ Iniciando Bronze com auto-triggers..."
	@$(MAKE) run_bronze && echo "âœ… Bronze concluÃ­do, triggering Silver..." && \
	$(MAKE) run_silver_with_triggers

# Silver com auto-triggers
run_silver_with_triggers:
	@echo "ðŸŒŸ Iniciando Silver com auto-triggers..."
	@$(MAKE) run_silver && echo "âœ… Silver concluÃ­do, triggering Gold e Training..." && \
	($(MAKE) run_gold &) && \
	$(MAKE) run_training_with_triggers

# Training com auto-triggers
run_training_with_triggers:
	@echo "ðŸŒŸ Iniciando Training com auto-triggers..."
	@$(MAKE) run_training && echo "âœ… Training concluÃ­do, triggering Monitoring..." && \
	$(MAKE) run_monitoring

# Pipeline completo com triggers
run_full_pipeline_triggered:
	@echo "ðŸš€ Pipeline COMPLETO com auto-triggers..."
	@echo "Fluxo: Bronze â†’ Silver â†’ [Gold + Training] â†’ Monitoring"
	@$(MAKE) run_bronze_with_triggers

# =====================================
# ðŸ” Monitoramento e Status
# =====================================

# Listar jobs
list_jobs:
	@echo "ðŸ“‹ Listando jobs do bundle..."
	@set -a && . ./.env && set +a && \
	databricks jobs list

# Verificar status dos jobs essenciais
check_essential_status:
	@echo "ðŸ” Verificando status dos jobs essenciais..."
	@set -a && . ./.env && set +a && \
	databricks jobs list --output json | jq '.jobs[] | select(.settings.name | contains("iris_")) | {name: .settings.name, job_id: .job_id}'

# Verificar tabelas Unity Catalog
check_tables:
	@echo "ðŸ“‹ Verificando tabelas Unity Catalog..."
	@set -a && . ./.env && set +a && \
	databricks unity-catalog list-tables workspace.default 2>/dev/null || echo "Usando SQL direto..." && \
	databricks sql execute "SHOW TABLES IN workspace.default"

# =====================================
# ðŸ§¹ Limpeza e UtilitÃ¡rios
# =====================================

# Limpeza de arquivos temporÃ¡rios
clean:
	@echo "ðŸ§¹ Limpando arquivos temporÃ¡rios..."
	rm -rf __pycache__ dist *.egg-info .pytest_cache .mypy_cache .coverage

# =====================================
# ðŸ’¡ Ajuda
# =====================================

help:
	@echo "ðŸŒ¸ Iris MLOps Pipeline - Comandos DisponÃ­veis"
	@echo ""
	@echo "ðŸ”§ Setup:"
	@echo "  make install-databricks    -> Instalar Databricks CLI"
	@echo "  make test-auth            -> Testar autenticaÃ§Ã£o"
	@echo ""
	@echo "ðŸ“¦ Deploy:"
	@echo "  make validate             -> Validar configuraÃ§Ã£o"
	@echo "  make deploy               -> Deploy do bundle"
	@echo ""
	@echo "ðŸŽ¯ Jobs Individuais:"
	@echo "  make run_bronze           -> Job Bronze (ingestÃ£o)"
	@echo "  make run_silver           -> Job Silver (transformaÃ§Ã£o)"
	@echo "  make run_gold            -> Job Gold (agregaÃ§Ã£o)"
	@echo "  make run_training        -> Job Training (ML)"
	@echo "  make run_monitoring      -> Job Monitoring"
	@echo "  make run_complete_pipeline -> Pipeline orquestrado"
	@echo ""
	@echo "ðŸ”„ Pipelines com Auto-triggers:"
	@echo "  make run_bronze_with_triggers     -> Bronze â†’ Silver â†’ [Gold + Training] â†’ Monitoring"
	@echo "  make run_full_pipeline_triggered  -> Pipeline completo com auto-triggers"
	@echo ""
	@echo "ðŸ” Monitoramento:"
	@echo "  make list_jobs               -> Listar jobs"
	@echo "  make check_essential_status  -> Status dos jobs"
	@echo "  make check_tables           -> Verificar tabelas"
	@echo ""
	@echo "ðŸŒŸ Comando Recomendado:"
	@echo "  make run_bronze_with_triggers  # Executa todo o pipeline automaticamente"

.PHONY: help install-databricks test-auth validate deploy run_bronze run_silver run_gold run_training run_monitoring run_complete_pipeline run_bronze_with_triggers run_silver_with_triggers run_training_with_triggers run_full_pipeline_triggered list_jobs check_essential_status check_tables clean

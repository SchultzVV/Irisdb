# =====================================
# ğŸŒ¸ Iris MLOps Pipeline - Makefile Clean
# =====================================
-include .env
export

# =====================================
# ğŸ› ï¸ ConfiguraÃ§Ã£o
# =====================================
DATABRICKS_BIN := databricks

# =====================================
# ğŸ”§ Setup e AutenticaÃ§Ã£o
# =====================================

# ğŸ› ï¸ Instala Databricks CLI v0.205+
install-databricks:
	@echo "ğŸš€ Instalando Databricks CLI oficial..."
	@curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
	@echo "âœ… Databricks CLI instalada!"
	@databricks version

# ğŸ” Teste de autenticaÃ§Ã£o
test-auth:
	@echo "ğŸ” Testando autenticaÃ§Ã£o..."
	@set -a && . ./.env && set +a && \
	databricks current-user me

# =====================================
# ğŸ“¦ Deploy e ValidaÃ§Ã£o
# =====================================

# âœ… Validar bundle
validate:
	@echo "ğŸ” Validando bundle..."
	@set -a && . ./.env && set +a && \
	$(DATABRICKS_BIN) bundle validate

# ğŸš€ Deploy do bundle
deploy:
	@echo "ğŸš€ Fazendo deploy..."
	@set -a && . ./.env && set +a && \
	$(DATABRICKS_BIN) bundle deploy --target dev

# =====================================
# ğŸ¯ Jobs Essenciais
# =====================================

# ğŸ¥‰ Bronze job (IngestÃ£o)
run_bronze:
	@echo "ğŸ¥‰ Executando Bronze job..."
	@set -a && . ./.env && set +a && \
	databricks bundle run bronze_job

# ğŸ¥ˆ Silver job (TransformaÃ§Ã£o)
run_silver:
	@echo "ğŸ¥ˆ Executando Silver job..."
	@set -a && . ./.env && set +a && \
	databricks bundle run silver_job

# ğŸ¥‡ Gold job (AgregaÃ§Ã£o)
run_gold:
	@echo "ğŸ¥‡ Executando Gold job..."
	@set -a && . ./.env && set +a && \
	databricks bundle run gold_job

# ğŸ¤– Training job (ML)
run_training:
	@echo "ğŸ¤– Executando Training job..."
	@set -a && . ./.env && set +a && \
	databricks bundle run training_job

# ğŸ”® Inference job
run_inference:
	@echo "ğŸ”® Executando Inference job..."
	@set -a && . ./.env && set +a && \
	databricks bundle run inference_job

# =====================================
# ğŸš€ Pipeline Workflows
# =====================================

# ğŸ”„ Pipeline sequencial bÃ¡sico
run_pipeline:
	@echo "ğŸš€ Executando pipeline sequencial..."
	@$(MAKE) run_bronze
	@$(MAKE) run_silver
	@$(MAKE) run_gold
	@$(MAKE) run_training
	@$(MAKE) run_inference

# ğŸ¤– CI/CD: Deploy e executar pipeline
ci_deploy_and_run:
	@echo "ğŸ¤– CI/CD: Deploy e execuÃ§Ã£o do pipeline..."
	@$(MAKE) validate
	@$(MAKE) deploy
	@$(MAKE) run_pipeline

# =====================================
# ğŸ§¹ UtilitÃ¡rios
# =====================================

# ğŸ“‹ Listar jobs disponÃ­veis
list-jobs:
	@echo "ğŸ“‹ Jobs disponÃ­veis:"
	@echo "  ğŸ¥‰ run_bronze    - IngestÃ£o de dados (01_ingest_bronze)"
	@echo "  ğŸ¥ˆ run_silver    - TransformaÃ§Ã£o (02_transform_silver)"
	@echo "  ğŸ¥‡ run_gold      - AgregaÃ§Ã£o (03_aggregate_gold)"
	@echo "  ğŸ¤– run_training  - Treinamento ML (04_train_model)"
	@echo "  ğŸ”® run_inference - InferÃªncia ML (05_model_inference)"
	@echo "  ğŸš€ run_pipeline  - Pipeline completo sequencial"

# ğŸ“Š Status do projeto
status:
	@echo "ğŸ“Š Status do Projeto Iris MLOps:"
	@echo "  ğŸ“ Notebooks: 5 essenciais"
	@echo "  âš™ï¸ Jobs: 5 principais"
	@echo "  ğŸ”§ Pipeline: Bronze â†’ Silver â†’ Gold â†’ Training â†’ Inference"
	@echo "  ğŸ–¥ï¸ Compute: Serverless (configuraÃ§Ã£o de cluster comentada)"
	@echo "  âœ… Status: Pronto para produÃ§Ã£o"

# ğŸ†˜ Ajuda
help:
	@echo "ğŸŒ¸ Iris MLOps Pipeline - Comandos disponÃ­veis:"
	@echo ""
	@echo "ğŸ”§ Setup:"
	@echo "  make install-databricks  - Instalar Databricks CLI"
	@echo "  make test-auth          - Testar autenticaÃ§Ã£o"
	@echo ""
	@echo "ğŸ“¦ Deploy:"
	@echo "  make validate           - Validar bundle"
	@echo "  make deploy             - Deploy do bundle"
	@echo ""
	@echo "ğŸ¯ Jobs individuais:"
	@echo "  make run_bronze         - Executar ingestÃ£o"
	@echo "  make run_silver         - Executar transformaÃ§Ã£o"
	@echo "  make run_gold           - Executar agregaÃ§Ã£o"
	@echo "  make run_training       - Executar treinamento ML"
	@echo "  make run_inference      - Executar inferÃªncia ML"
	@echo ""
	@echo "ğŸš€ Pipelines:"
	@echo "  make run_pipeline       - Pipeline completo"
	@echo "  make ci_deploy_and_run  - CI/CD completo"
	@echo ""
	@echo "ğŸ§¹ UtilitÃ¡rios:"
	@echo "  make list-jobs          - Listar jobs"
	@echo "  make status             - Status do projeto"
	@echo "  make help               - Esta ajuda"

.PHONY: install-databricks test-auth validate deploy run_bronze run_silver run_gold run_training run_inference run_pipeline ci_deploy_and_run list-jobs status help

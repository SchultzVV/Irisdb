# =====================================
# üåê Vari√°veis de ambiente
# =====================================
export $(shell sed 's/=.*//' .env)
include .env
# =====================================
# üß™ Comandos principais
# =====================================

# Caminho padr√£o onde a CLI ser√° instalada
DATABRICKS_CLI_DIR := $(HOME)/.databricks/bin
DATABRICKS_BIN := databricks
OS := $(shell uname -s | tr A-Z a-z)

# üõ†Ô∏è Instala Databricks CLI v0.205+ com curl
install-databricks:
	@echo "üöÄ Instalando Databricks CLI oficial (v0.205+)..."
# 	@which databricks >/dev/null 2>&1 && databricks version && echo "‚úÖ J√° instalada!" && exit 0
	@curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
	@echo "‚úÖ Databricks CLI instalada com sucesso!"
	@echo "üîç Verificando vers√£o..."
	@which databricks && databricks version



# ‚úÖ Alvo de login com verifica√ß√£o de autentica√ß√£o usando vari√°veis do .env
login:
	@echo "üîê Carregando credenciais do .env..."
	@if [ -f .env ]; then \
		set -a && . ./.env && set +a && \
		databricks workspace list /; \
	else \
		echo "‚ùå Arquivo .env n√£o encontrado!"; \
		exit 1; \
	fi

# üîê Teste simples de autentica√ß√£o sem valida√ß√£o do bundle
test-auth:
	@echo "üîê Testando autentica√ß√£o..."
	@set -a && . ./.env && set +a && \
	cd /tmp && databricks current-user me

# Alvo para validar, fazer deploy e rodar pipeline
validate:
	@set -a && . ./.env && set +a && \
	$(DATABRICKS_BIN) bundle validate

deploy:
	@set -a && . ./.env && set +a && \
	$(DATABRICKS_BIN) bundle deploy --target dev

run:
	@set -a && . ./.env && set +a && \
	$(DATABRICKS_BIN) bundle run iris_pipeline --target dev

test-pipeline:
	@set -a && . ./.env && set +a && \
	$(DATABRICKS_BIN) bundle run test_pipeline --target dev

# =====================================
# üßπ Limpeza e debug
# =====================================

clean:
	rm -rf __pycache__ dist *.egg-info .pytest_cache .mypy_cache .coverage

# =====================================
# üí° Ajuda
# =====================================

help:
	@echo "Comandos dispon√≠veis:"
	@echo "  make login               -> Autentica via token"
	@echo "  make validate            -> Valida a estrutura do bundle"
	@echo "  make deploy              -> Sobe c√≥digo e recursos para o Databricks"
	@echo "  make run-pipeline        -> Executa pipeline principal"
	@echo "  make run-test-pipeline   -> Executa pipeline de teste com dados mock"
	@echo "  make logout              -> Remove autentica√ß√£o local"
	@echo "  make clean               -> Remove arquivos tempor√°rios"

# =====================================
# ‚öôÔ∏è Instala√ß√£o do Databricks CLI v2
# =====================================
